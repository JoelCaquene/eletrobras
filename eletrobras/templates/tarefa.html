<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Máquina - ELETROBRAS</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        :root {
            --cor-fundo-principal: #FFFFFF;
            --cor-card-fundo: #F9FAFB;
            --cor-borda-card: #E5E7EB;
            --cor-texto-principal: #1F2937;
            --cor-texto-secundario: #6B7280;
            --cor-destaque: #007bff;
            --cor-brilho: #0056b3;
            --cor-sucesso: #28a745;
            --cor-aviso: #ffc107;
            --cor-inativo: #dc3545;
            --sombra-leve: 0 4px 12px rgba(0, 0, 0, 0.08);
            --sombra-intensa: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        body {
            background-color: var(--cor-fundo-principal);
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            overflow-y: auto;
        }

        .header {
            width: 100%;
            padding: 20px;
            background: var(--cor-fundo-principal);
            border-bottom: 1px solid var(--cor-borda-card);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            color: var(--cor-texto-principal);
            font-size: 1.8em;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 1000;
            text-align: center;
        }

        .container {
            width: 90%;
            max-width: 600px;
            margin-top: 40px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .machine-container {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #2c3e50;
            border-radius: 15px;
            box-shadow: var(--sombra-intensa);
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .machine-svg {
            width: 90%;
            height: auto;
            max-width: 500px;
        }

        .light-bulb, .power-line {
            transition: fill 0.5s ease-in-out, stroke 0.5s ease-in-out;
        }
        
        .light-on {
            fill: #ffeb3b;
            filter: drop-shadow(0 0 8px #ffeb3b) drop-shadow(0 0 12px #ffeb3b);
        }
        
        .light-off {
            fill: #888;
        }

        .line-active {
            stroke: #28a745;
            filter: drop-shadow(0 0 5px #28a745) drop-shadow(0 0 10px #28a745);
        }

        .line-inactive {
            stroke: #666;
        }

        .status-card {
            background-color: var(--cor-card-fundo);
            border: 1px solid var(--cor-borda-card);
            border-radius: 12px;
            box-shadow: var(--sombra-leve);
            padding: 20px;
            margin-top: 30px;
            width: 100%;
            text-align: center;
        }

        .status-card h3 {
            color: var(--cor-texto-principal);
            font-size: 1.5em;
            margin: 0 0 10px;
        }

        .status-card p {
            color: var(--cor-texto-secundario);
            margin: 0;
        }

        .message {
            color: var(--cor-aviso);
            font-weight: 600;
            margin-top: 15px;
        }

        .gain-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 30px;
            background-image: linear-gradient(45deg, #007bff, #0056b3);
            color: #FFFFFF;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.3s;
            text-transform: uppercase;
            margin-top: 30px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            letter-spacing: 1px;
        }
        
        .gain-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
        }
        
        .gain-button:disabled {
            background-image: none;
            background-color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Minha Máquina</h1>
    </div>

    <div class="container">
        <form id="csrf-form" style="display:none;">
            {% csrf_token %}
        </form>

        <div class="machine-container">
            <svg class="machine-svg" viewBox="0 0 500 300" xmlns="http://www.w3.org/2000/svg">
                <rect x="50" y="200" width="400" height="80" rx="10" fill="#34495e"/>
                <rect x="100" y="50" width="300" height="150" rx="15" fill="#5D6D7E"/>
                <rect x="120" y="60" width="260" height="130" rx="10" fill="#2c3e50" stroke="#7f8c8d" stroke-width="2"/>
                <circle id="lamp1" cx="150" cy="90" r="15" class="light-bulb light-off"/>
                <circle id="lamp2" cx="250" cy="90" r="15" class="light-bulb light-off"/>
                <circle id="lamp3" cx="350" cy="90" r="15" class="light-bulb light-off"/>
                <line x1="250" y1="120" x2="250" y2="190" stroke-width="5" class="power-line line-inactive"/>
                <line x1="150" y1="120" x2="250" y2="120" stroke-width="5" class="power-line line-inactive"/>
                <line x1="350" y1="120" x2="250" y2="120" stroke-width="5" class="power-line line-inactive"/>
                <circle cx="250" cy="190" r="20" fill="#e74c3c" stroke="#c0392b" stroke-width="3"/>
                <text x="250" y="195" font-family="Arial" font-size="12" fill="#fff" text-anchor="middle" alignment-baseline="middle" font-weight="bold">START</text>
            </svg>
        </div>

        <div class="status-card">
            <h3 id="status-title">Status da Máquina</h3>
            <p id="status-message">Conectando...</p>
        </div>

        <button id="generate-energy-btn" class="gain-button" disabled>Gerar Energia</button>
    </div>

    <script>
        const generateEnergyBtn = document.getElementById('generate-energy-btn');
        const statusTitle = document.getElementById('status-title');
        const statusMessage = document.getElementById('status-message');
        const lamps = document.querySelectorAll('.light-bulb');
        const lines = document.querySelectorAll('.power-line');
        // Obtém o token CSRF do formulário invisível
        const csrftoken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

        let machineAnimation = null;
        
        function animateMachine() {
            let active = false;
            const animationInterval = setInterval(() => {
                active = !active;
                lamps.forEach(lamp => {
                    if (active) {
                        lamp.classList.add('light-on');
                        lamp.classList.remove('light-off');
                    } else {
                        lamp.classList.add('light-off');
                        lamp.classList.remove('light-on');
                    }
                });
                lines.forEach(line => {
                    if (active) {
                        line.classList.add('line-active');
                        line.classList.remove('line-inactive');
                    } else {
                        line.classList.add('line-inactive');
                        line.classList.remove('line-active');
                    }
                });
            }, 300);
            return animationInterval;
        }

        function updateUI(hasActiveLevel, tarefaRealizadaHoje) {
            if (machineAnimation) {
                clearInterval(machineAnimation);
            }

            if (!hasActiveLevel) {
                generateEnergyBtn.disabled = true;
                statusTitle.textContent = "Máquina Inativa";
                statusMessage.textContent = "Você precisa alugar um nível para ativar a máquina.";
                generateEnergyBtn.textContent = "Alugue um Nível";
                lamps.forEach(lamp => { lamp.classList.add('light-off'); lamp.classList.remove('light-on'); });
                lines.forEach(line => { line.classList.add('line-inactive'); line.classList.remove('line-active'); });
                machineAnimation = animateMachine();
            } else if (tarefaRealizadaHoje) {
                generateEnergyBtn.disabled = true;
                statusTitle.textContent = "Energia Gerada!";
                statusMessage.textContent = "A tarefa de hoje já foi realizada. Volte amanhã.";
                generateEnergyBtn.textContent = "Volte Amanhã";
                lamps.forEach(lamp => { lamp.classList.add('light-on'); lamp.classList.remove('light-off'); });
                lines.forEach(line => { line.classList.add('line-active'); line.classList.remove('line-inactive'); });
            } else {
                generateEnergyBtn.disabled = false;
                statusTitle.textContent = "Pronto para Gerar";
                statusMessage.textContent = "Clique para gerar energia e coletar seu ganho diário.";
                generateEnergyBtn.textContent = "Gerar Energia";
                lamps.forEach(lamp => { lamp.classList.add('light-off'); lamp.classList.remove('light-on'); });
                lines.forEach(line => { line.classList.add('line-inactive'); line.classList.remove('line-active'); });
            }
        }
        
        generateEnergyBtn.addEventListener('click', async () => {
            if (generateEnergyBtn.disabled) return;

            generateEnergyBtn.disabled = true;
            statusTitle.textContent = "Gerando Energia...";
            statusMessage.textContent = "Processando seu ganho, por favor aguarde...";
            
            const animationInterval = animateMachine();

            try {
                const response = await fetch('/realizar-tarefa/', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken 
                    },
                    body: JSON.stringify({ action: 'realizar_tarefa' })
                });
                const data = await response.json();

                clearInterval(animationInterval);

                if (response.ok) {
                    statusTitle.textContent = "Sucesso!";
                    statusMessage.textContent = data.message;
                    updateUI(true, true);
                } else {
                    statusTitle.textContent = "Erro!";
                    statusMessage.textContent = data.message;
                    generateEnergyBtn.disabled = false; 
                    updateUI(true, false);
                }
            } catch (error) {
                clearInterval(animationInterval);
                console.error('Erro:', error);
                statusTitle.textContent = "Erro de Conexão";
                statusMessage.textContent = "Erro ao realizar a tarefa. Tente novamente.";
                generateEnergyBtn.disabled = false; 
                updateUI(true, false);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const hasActiveLevel = {{ has_level|yesno:"true,false" }};
            const tarefaRealizadaHoje = {{ tarefa_realizada_hoje|yesno:"true,false" }};
            updateUI(hasActiveLevel, tarefaRealizadaHoje);
        });
    </script>
</body>
</html>
